flowchart LR
    classDef dataTransform fill:#d4f1f9,stroke:#05445E,stroke-width:2px,color:#05445E,font-weight:bold
    classDef dataSelection fill:#d8f3dc,stroke:#1B4332,stroke-width:2px,color:#1B4332,font-weight:bold
    classDef missingData fill:#fff1e6,stroke:#9E2A2B,stroke-width:2px,color:#9E2A2B,font-weight:bold
    classDef featureEng fill:#ede7f6,stroke:#4527a0,stroke-width:2px,color:#4527a0,font-weight:bold
    classDef datasetCreation fill:#e9ecef,stroke:#343a40,stroke-width:2px,color:#343a40,font-weight:bold
    classDef phaseTitle font-weight:bold,font-size:14px
    
    subgraph Process ["QUY TRÌNH TIỀN XỬ LÝ DỮ LIỆU"]
        direction TB
        
        subgraph DataTransformation ["1. CHUYỂN ĐỔI DỮ LIỆU"]
            direction LR
            A1["1.1 Lọc dữ liệu<br>theo mã thiết bị"] --> 
            A2["1.2 Tái cấu trúc dữ liệu<br>theo kênh đo"] --> 
            A3["1.3 Chuẩn hóa<br>định dạng thời gian"] -->
            A4["1.4 Xử lý<br>đơn vị đo"]
            
            subgraph DataStructure
                direction TB
                A21["Kênh 0: Áp suất đầu vào<br>(Pressure_1)"]
                A22["Kênh 1: Lưu lượng<br>(Flow)"]
                A23["Kênh 2: Áp suất đầu ra<br>(Pressure_2)"]
                
                A21 --- A22 --- A23
            end
            
            A2 ---- DataStructure
        end
        
        subgraph DataSelection ["2. CHỌN DỮ LIỆU HUẤN LUYỆN"]
            direction TB
            B1["2.1 Phân tích<br>các điểm đo"] --> 
            B2["2.2 Lựa chọn điểm đo<br>đủ 3 kênh dữ liệu"]
            
            subgraph DeviceAnalysis
                direction TB
                B21["Điểm 841211914190<br>(Đủ dữ liệu lưu lượng<br>32.05% dữ liệu thiếu)"]
                B22["Điểm 8401210607558<br>(Đủ dữ liệu lưu lượng<br>3.01% dữ liệu thiếu)"]
                
                B21 --- B22
            end
            
            B2 ---- DeviceAnalysis
        end
        
        subgraph MissingDataHandling ["3. XỬ LÝ DỮ LIỆU THIẾU"]
            direction LR
            C1["3.1 Phân tích<br>dữ liệu thiếu"] --> 
            C2["3.2 Phương pháp<br>xóa ngày có dữ liệu thiếu<br>(Listwise Deletion)"] --> 
            C3["3.3 Đánh giá<br>kết quả xử lý"]
            
            subgraph DeletionResults
                direction TB
                C31["Điểm 841211914190:<br>Còn lại 248 ngày (67.95%)"]
                C32["Điểm 8401210607558:<br>Còn lại 354 ngày (96.99%)"]
                
                C31 --- C32
            end
            
            C3 ---- DeletionResults
        end
        
        subgraph FeatureSelection ["4. LỰA CHỌN ĐẶC TRƯNG"]
            direction LR
            D1["4.1 Chiến lược 1:<br>Mô hình đơn biến<br>(chỉ dữ liệu lưu lượng)"] & D2["4.2 Chiến lược 2:<br>Mô hình đa biến<br>(lưu lượng và áp suất)"]
            
            subgraph WindowSelection
                direction TB
                D31["Cửa sổ 6 giờ<br>(24 điểm dữ liệu)<br>tần suất 15 phút"]
                D32["Giá trị dự đoán:<br>Lưu lượng tại<br>thời điểm tiếp theo"]
                
                D31 --> D32
            end
            
            D1 & D2 --> D3["4.3 Xác định kích thước<br>cửa sổ thời gian"]
            D3 ---- WindowSelection
        end
        
        subgraph TrainingDataCreation ["5. TẠO DỮ LIỆU HUẤN LUYỆN"]
            direction LR
            E1["5.1 Áp dụng phương pháp<br>cửa sổ trượt<br>(sliding window)"] --> 
            E2["5.2 Chia tập dữ liệu<br>huấn luyện/kiểm tra<br>(tỷ lệ 80:20)"]
            
            subgraph TrainingStrategies
                direction TB
                E21["Chiến lược A:<br>Mô hình riêng<br>cho từng điểm đo"]
                E22["Chiến lược B:<br>Mô hình chung<br>cho tất cả điểm đo"]
                
                E21 --- E22
            end
            
            E2 ---- TrainingStrategies
        end
    end
    
    DataTransformation --> DataSelection --> MissingDataHandling --> FeatureSelection --> TrainingDataCreation
    
    subgraph Details ["THÔNG TIN BỔ SUNG"]
        direction TB
        N1["Tần suất dữ liệu:<br>15 phút/mẫu"]
        N2["Khung thời gian:<br>Dữ liệu 1 năm"]
        N3["Chuỗi đầu vào:<br>Cửa sổ 6 giờ (24 điểm)"]
        N4["Chuỗi đầu ra:<br>Giá trị lưu lượng<br>tại t+1 (15 phút tiếp theo)"]
    end
    
    A1:::dataTransform
    A2:::dataTransform
    A3:::dataTransform
    A4:::dataTransform
    A21:::dataTransform
    A22:::dataTransform
    A23:::dataTransform
    B1:::dataSelection
    B2:::dataSelection
    B21:::dataSelection
    B22:::dataSelection
    C1:::missingData
    C2:::missingData
    C3:::missingData
    C31:::missingData
    C32:::missingData
    D1:::featureEng
    D2:::featureEng
    D3:::featureEng
    D31:::featureEng
    D32:::featureEng
    E1:::datasetCreation
    E2:::datasetCreation
    E21:::datasetCreation
    E22:::datasetCreation
    
    DataTransformation:::phaseTitle
    DataSelection:::phaseTitle
    MissingDataHandling:::phaseTitle
    FeatureSelection:::phaseTitle
    TrainingDataCreation:::phaseTitle
    Details:::phaseTitle 